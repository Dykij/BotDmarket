# Устранение проблем с балансом DMarket

## Проблема

Текущая реализация Dmarket API в боте использует неправильный эндпоинт для запроса баланса:

```python
# Неверный эндпоинт
"/account/v1/balance"
```

Согласно официальной документации DMarket API, правильный эндпоинт для получения баланса:

```python
# Правильный эндпоинт
"/v1/user/balance"
```

## Решение

В данном репозитории предоставлены несколько решений проблемы:

### Решение 1: Использование патча 

Мы создали патч, который автоматически подменяет метод `get_user_balance` в классе `DMarketAPI` и пытается использовать правильный эндпоинт, а при ошибке пробует старый эндпоинт.

Файлы патча:
- `src/dmarket/dmarket_api_balance_fix.py` - содержит основную реализацию патча
- `src/dmarket/balance_patch.py` - инициализирует патч при импорте

Для использования патча, просто импортируйте его перед использованием API:

```python
# Импортируем патч баланса до использования API
from src.dmarket.balance_patch import apply_balance_patch

# После этого можно импортировать и использовать API
from src.dmarket.dmarket_api import DMarketAPI
```

### Решение 2: Запуск бота с патчем

Для запуска бота с применением патча, используйте файл `run_fixed_bot.py`:

```bash
python run_fixed_bot.py
```

### Решение 3: Тестирование баланса

Для проверки работы API баланса с патчем используйте скрипт:

```bash
python scripts/test_fixed_balance.py
```

## Особенности решения

Патч включает:

1. Правильный эндпоинт из документации (`/v1/user/balance`)
2. Поддержку различных форматов ответа:
   - Строковые значения в ответе (`{"usd": "5.00"}`)
   - Числовые значения (`{"usd": 5.00}`)
   - Вложенные объекты (`{"usd": {"amount": 500}}`)
   - Поле `usdAvailableToWithdraw` из документации
3. Резервный механизм использования старого эндпоинта при ошибке с новым

## Дополнительная информация

Подробности форматов ответа:
- `usd` - баланс в USD
- `dmc` - баланс в DMC (внутренняя валюта DMarket)
- `usdAvailableToWithdraw` - доступные для вывода средства в USD
- `dmcAvailableToWithdraw` - доступные для вывода средства в DMC
