# Мониторинг цен в реальном времени

## Обзор

В проект DMarket Bot добавлена новая функциональность мониторинга цен предметов в реальном времени с использованием WebSocket API DMarket. Эта функциональность позволяет отслеживать изменения цен на интересующие пользователя предметы и получать уведомления при достижении заданных условий.

## Основные компоненты

### WebSocket клиент для DMarket API

Модуль `src/utils/websocket_client.py` реализует асинхронный клиент для работы с WebSocket API DMarket. Основные возможности:

- Подключение к WebSocket API с использованием токена аутентификации
- Поддержка автоматического переподключения при обрыве соединения
- Подписка/отписка на различные каналы обновлений
- Регистрация обработчиков для различных типов сообщений

Пример использования:

```python
# Создаем экземпляр WebSocket клиента
ws_client = DMarketWebSocketClient(api_client)

# Регистрируем обработчик сообщений
ws_client.register_handler("market:update", handle_market_update)

# Подключаемся к WebSocket API
await ws_client.connect()

# Подписываемся на канал обновлений рынка
await ws_client.subscribe("market:update")

# Запускаем прослушивание сообщений
await ws_client.listen()
```

### Модуль отслеживания цен в реальном времени

Модуль `src/dmarket/realtime_price_watcher.py` использует WebSocket клиент для отслеживания цен предметов и обработки оповещений. Основные возможности:

- Отслеживание цен на выбранные предметы в реальном времени
- Создание оповещений о достижении заданных условий цены
- Регистрация обработчиков для различных событий (изменение цены, срабатывание оповещения)
- Кеширование последних известных цен предметов

Пример использования:

```python
# Создаем наблюдатель за ценами
watcher = RealtimePriceWatcher(api_client)

# Регистрируем обработчик изменения цены
watcher.register_price_change_handler(on_price_change)

# Регистрируем обработчик срабатывания оповещения
watcher.register_alert_handler(on_alert_triggered)

# Добавляем оповещение о цене
alert = PriceAlert(
    item_id="123456",
    market_hash_name="AWP | Asiimov (Field-Tested)",
    target_price=50.0,
    condition="below"
)
watcher.add_price_alert(alert)

# Запускаем наблюдатель
await watcher.start()
```

### Интеграция с Telegram ботом

Модуль `src/telegram_bot/price_alerts_handler.py` реализует интеграцию функциональности мониторинга цен с Telegram ботом. Основные возможности:

- Команда `/price_alerts` для управления оповещениями о ценах
- Создание новых оповещений через диалоговый интерфейс
- Просмотр и удаление существующих оповещений
- Получение уведомлений в Telegram при срабатывании оповещений

## Как использовать

1. Запустите бота командой `python run.py`
2. Отправьте команду `/price_alerts` в чате с ботом
3. Выберите "Добавить оповещение"
4. Следуйте инструкциям бота для создания оповещения:
   - Введите название предмета (market_hash_name)
   - Введите целевую цену
   - Выберите условие срабатывания (цена ниже/выше указанной)
5. Получайте уведомления, когда цена достигнет указанного условия

## Технические детали

### Структура данных оповещения о цене

```python
class PriceAlert:
    """Класс для представления оповещения о цене."""
    
    def __init__(
        self, 
        item_id: str, 
        market_hash_name: str,
        target_price: float,
        condition: str = "below",  # "below" или "above"
        game: str = "csgo"
    ):
        # ...
```

### Хранение оповещений в Telegram боте

Оповещения хранятся в `context.user_data[PRICE_ALERT_STORAGE_KEY]` для каждого пользователя в формате:

```python
{
    "alert_id": {
        "market_hash_name": "AWP | Asiimov (Field-Tested)",
        "target_price": 50.0,
        "condition": "below",
        "created_at": timestamp,
        "is_triggered": False
    }
}
```

## Планы по улучшению

1. Добавить поддержку временных условий для оповещений (например, срабатывание только в определенный период времени)
2. Реализовать визуализацию изменения цен в виде графиков
3. Добавить механизм динамического трекинга трендов цен и автоматического определения выгодных возможностей 