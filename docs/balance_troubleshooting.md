# Руководство по устранению проблем с отображением баланса DMarket

В этом руководстве описаны наиболее распространенные проблемы, связанные с отображением баланса DMarket в Telegram боте, и способы их решения.

## Основные причины проблем с отображением баланса

1. **Проблемы с аутентификацией**
   - Неверные или устаревшие API ключи DMarket
   - Неправильное формирование заголовков авторизации
   - Недостаточные права доступа у API ключей

2. **Проблемы с API эндпоинтами**
   - Изменения в API DMarket (например, `/account/v1/balance` вместо `/v1/user/balance`)
   - Несовместимость версий API

3. **Проблемы с обработкой ответа API**
   - Изменение формата ответа API
   - Ошибки при парсинге данных о балансе

4. **Ограничения по частоте запросов (Rate Limiting)**
   - Превышение лимита запросов к DMarket API

## Как решить проблему

### 1. Проверка API ключей

```bash
# Запустите тест для проверки API ключей
python scripts/test_direct_balance.py
```

Убедитесь, что API ключи корректны и имеют достаточные права доступа:
- Проверьте файл `.env` в корне проекта
- Убедитесь что переменные `DMARKET_PUBLIC_KEY` и `DMARKET_SECRET_KEY` заполнены корректными значениями

### 2. Обновление патча для получения баланса

Бот использует патч для добавления метода получения баланса к основному API клиенту. Убедитесь, что патч правильно применен:

```python
# В вашем коде должна быть добавлена следующая строка в начале работы бота
from src.dmarket.dmarket_api_patches import apply_balance_patch
apply_balance_patch()
```

### 3. Проверка формата ответа API

Если формат ответа API изменился, возможно, потребуется обновить логику обработки ответа. Текущий код поддерживает следующие форматы:

- `{"usd": "5.00"}` - строковое представление в долларах
- `{"usd": 5.00}` - числовое представление в долларах
- `{"usd": {"amount": 500}}` - объект с суммой в центах
- `{"balance": {"usd": 500}}` - вложенный объект баланса
- `{"usdAvailableToWithdraw": 5.00}` - сумма, доступная для вывода

### 4. Отладка проблемы

Для отладки проблем с балансом используйте тестовые скрипты:

```bash
# Тест с патчем
python scripts/test_balance_with_patch.py

# Тест с прямым запросом к API
python scripts/test_direct_balance.py
```

### 5. Проверка эндпоинта API

В текущей версии бот сначала пытается использовать эндпоинт `/v1/user/balance`, а затем `/account/v1/balance`. Если API DMarket изменился, может потребоваться обновление эндпоинтов в файлах:

- `src/dmarket/dmarket_api_balance.py`
- `src/dmarket/dmarket_api_patch.py`

## Технические детали

### Логика метода получения баланса

Метод `get_user_balance` выполняет следующие шаги:

1. Отправляет запрос на получение баланса
2. Проверяет наличие ошибок в ответе
3. Обрабатывает различные форматы ответа API
4. Возвращает стандартизированный формат `{"usd": {"amount": value_in_cents}}`

### Процесс аутентификации

Для запросов к DMarket API используется следующий механизм аутентификации:

1. Формирование строки для подписи: `timestamp + method + path`
2. Создание подписи с использованием HMAC-SHA256
3. Добавление заголовков:
   - `X-Api-Key`: Публичный ключ API
   - `X-Request-Sign`: `timestampString={timestamp};signatureString={signature}`

## Дополнительная информация

Если проблемы с отображением баланса сохраняются, проверьте актуальную документацию DMarket API и обновите код в соответствии с изменениями в API.
